name: Sync Jira to Project Tasks

on:
  # Trigger on Jira webhook (configured in Jira)
  repository_dispatch:
    types: [jira-issue-created, jira-issue-updated]
  
  # Manual trigger
  workflow_dispatch:
  
  # Auto-sync on push to project-task.md files
  push:
    paths:
      - 'Applications/AITooling/Services/SecurityService/.kiro/specs/security-service/project-task.md'
      - 'Applications/AITooling/Services/DataLoaderService/.kiro/specs/data-loader-service/project-task.md'

jobs:
  sync-jira-to-tasks:
    runs-on: ubuntu-latest
    name: Sync Jira Issues to Project Tasks
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup PowerShell
        uses: powershell/setup-powershell@v1
        with:
          pwsh: true
      
      - name: Run Jira sync script
        shell: pwsh
        run: |
          .\scripts\sync-jira-to-tasks.ps1 -Verbose
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      
      - name: Commit changes
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check if there are changes
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git add "Applications/*/Services/*/.kiro/specs/*/project-task.md"
          git commit -m "chore: sync Jira tasks to project-task.md files [skip ci]"
          git push
      
      - name: Report sync status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const status = '${{ job.status }}';
            
            console.log(`Jira sync completed with status: ${status}`);
            
            if (status === 'success') {
              core.notice('✅ Jira tasks successfully synced to project-task.md files');
            } else {
              core.warning('⚠️ Jira sync encountered issues. Check logs for details.');
            }

  sync-tasks-to-jira:
    runs-on: ubuntu-latest
    name: Sync Project Tasks to Jira Issues
    needs: sync-jira-to-tasks
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup PowerShell
        uses: powershell/setup-powershell@v1
        with:
          pwsh: true
      
      - name: Sync SecurityService tasks to Jira
        shell: pwsh
        working-directory: Applications/AITooling/Services/SecurityService
        run: |
          .\.kiro\scripts\jira-sync.ps1 -Mode Auto -SyncOnly
        env:
          JIRA_BASE_URI: ${{ secrets.JIRA_BASE_URL }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          JIRA_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        continue-on-error: true
      
      - name: Sync DataLoaderService tasks to Jira
        shell: pwsh
        working-directory: Applications/AITooling/Services/DataLoaderService
        run: |
          .\.kiro\scripts\jira-sync.ps1 -Mode Auto -SyncOnly
        env:
          JIRA_BASE_URI: ${{ secrets.JIRA_BASE_URL }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          JIRA_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        continue-on-error: true
      
      - name: Commit changes
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check if there are changes
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git add "Applications/*/Services/*/.kiro/specs/*/project-task.md"
          git commit -m "chore: sync project-task.md to Jira issues [skip ci]"
          git push
      
      - name: Report sync status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const status = '${{ job.status }}';
            
            console.log(`Tasks to Jira sync completed with status: ${status}`);
            
            if (status === 'success') {
              core.notice('✅ Project tasks synced to Jira issues');
            } else {
              core.warning('⚠️ Tasks to Jira sync encountered issues. Check logs for details.');
            }

  validate-sync:
    runs-on: ubuntu-latest
    name: Validate Sync Results
    needs: [sync-jira-to-tasks, sync-tasks-to-jira]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate project-task.md files
        shell: pwsh
        run: |
          $serviceFiles = @(
            'Applications/AITooling/Services/SecurityService/.kiro/specs/security-service/project-task.md',
            'Applications/AITooling/Services/DataLoaderService/.kiro/specs/data-loader-service/project-task.md'
          )
          
          $allValid = $true
          
          foreach ($file in $serviceFiles) {
            if (-not (Test-Path $file)) {
              Write-Warning "File not found: $file"
              $allValid = $false
              continue
            }
            
            $content = Get-Content $file -Raw
            
            # Check for valid task format
            if ($content -match '- \[[ x~-]\]') {
              Write-Host "OK $file has valid task format"
            } else {
              Write-Warning "✗ $file has no valid tasks"
            }
          }
          
          if (-not $allValid) {
            Write-Error "Some project-task.md files are missing"
            exit 1
          }
          
          Write-Host "OK All project-task.md files validated"
