name: Jira Sync

on:
  push:
    branches: [ develop ]
    paths:
      - 'tasks.md'
      - '.kiro/specs/*/tasks.md'

env:
  JIRA_BASE_URL: https://wealthfid.atlassian.net
  CONFLUENCE_BASE_URL: https://wealthfid.atlassian.net/wiki

jobs:
  sync-tasks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          tasks.md
          .kiro/specs/*/tasks.md
    
    - name: Parse tasks
      id: parse
      run: |
        echo "Parsing tasks from changed files..."
        echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"
        # Task parsing logic would go here
        # For now, this is a placeholder
    
    - name: Create Jira issues
      id: jira
      env:
        JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
      run: |
        echo "Creating Jira issues..."
        # Jira issue creation logic would go here
        # For now, this is a placeholder
    
    - name: Update tasks.md with Jira links
      run: |
        echo "Updating tasks.md with Jira links..."
        # Task update logic would go here
        # For now, this is a placeholder
    
    - name: Commit and push updates
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        
        # Check if there are changes
        if git diff --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        
        # Commit changes
        git add tasks.md .kiro/specs/*/tasks.md
        git commit -m "chore: Update tasks.md with Jira links

- Created Jira issues for new tasks
- Updated tasks.md with Jira issue links
- Automated by GitHub Actions"
        
        # Push changes
        git push origin develop
    
    - name: Post GitHub comment
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '## Jira Sync Results\n\nâœ… Jira sync completed successfully'
          });
    
    - name: Send Slack notification
      if: always()
      uses: slackapi/slack-github-action@v1.24.0
      with:
        payload: |
          {
            "text": "Jira Sync Workflow",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Jira Sync Status*\n${{ job.status }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Repository*\n${{ github.repository }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch*\ndevelop"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Commit*\n${{ github.sha }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Author*\n${{ github.actor }}"
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
