name: Sync Project Tasks to Jira

on:
  workflow_dispatch:
  push:
    branches: [ main, develop ]
    paths:
      - 'Applications/AITooling/Services/*/project-task.md'
  schedule:
    - cron: '0 * * * *'  # Every hour

jobs:
  sync:
    runs-on: ubuntu-latest
    name: Bidirectional Jira Sync
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "PowerShell version: $($PSVersionTable.PSVersion)"

      - name: Run bidirectional sync
        shell: pwsh
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          & ./scripts/sync-jira-bidirectional.ps1

      - name: Commit changes
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if (git diff --quiet) {
            Write-Host "No changes to commit"
            exit 0
          }
          
          git add 'Applications/AITooling/Services/*/project-task.md'
          git commit -m "chore: sync Jira issues to project-task.md files"
          git push
